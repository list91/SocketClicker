# Проверка синхронизации обработки очереди команд

## Проблема
В текущей реализации есть подозрение на асинхронную обработку очереди команд, что может приводить к:
1. Параллельному выполнению нескольких команд
2. Некорректной обработке истории команд
3. Потенциальным race conditions при обновлении состояния

## Текущее поведение
- Команды запрашиваются через setInterval каждые N миллисекунд
- Обработка команды может занимать разное время из-за:
  - Ожидания появления элементов (waitForElement)
  - Выполнения действий (click, input)
  - Сетевых задержек при навигации
- История команд обновляется после выполнения

## Необходимые проверки
1. Проверить, что новая команда не начинает выполняться, пока не завершена текущая:
   - При успешном выполнении
   - При ошибке
   - При таймауте ожидания элемента
   
2. Проверить корректность обновления истории:
   - Команды должны добавляться в том же порядке, в котором выполнялись
   - Статус команды должен корректно отражать результат выполнения
   
3. Проверить обработку параллельных запросов:
   - При получении новых команд во время выполнения текущей
   - При одновременном запросе команд с нескольких вкладок

## Возможные решения
1. Добавить флаг isProcessing для блокировки параллельной обработки
2. Использовать очередь Promise для последовательного выполнения
3. Добавить механизм блокировки на уровне вкладки

## Метрики успеха
1. Команды выполняются строго последовательно
2. История команд отражает реальный порядок выполнения
3. Отсутствуют race conditions при параллельных запросах

## Тестовые сценарии
1. Отправка серии быстрых команд:
```json
[
  {
    "command": "execute_sequence",
    "params": {
      "data": [
        {"action": "go", "value": "https://example.com"},
        {"action": "input", "value": "test"}
      ]
    }
  },
  {
    "command": "execute_sequence",
    "params": {
      "data": [
        {"action": "click", "element_xpath": "//button"}
      ]
    }
  }
]
```

2. Команда с длительным ожиданием элемента:
```json
{
  "command": "execute_sequence",
  "params": {
    "data": [
      {
        "action": "click",
        "element_xpath": "//div[@id='slow-loading']",
        "on_start": 10000
      }
    ]
  }
}
```

## Логирование
Добавить подробное логирование:
- Начало/конец обработки каждой команды
- Состояние очереди
- Временные метки для отслеживания последовательности
